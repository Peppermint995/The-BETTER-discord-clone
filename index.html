<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Local Chat App</title>
<style>
  body { margin: 0; font-family: Arial, sans-serif; background: #121212; color: #fff; }
  .hidden { display: none; }
  #login, #chat { padding: 20px; }
  input, button { padding: 10px; margin: 5px 0; width: 100%; }
  #messages { height: 300px; overflow-y: auto; border: 1px solid #555; padding: 10px; background: #1f1f1f; margin-bottom: 10px; }
  .message { margin-bottom: 5px; }
  .group { font-weight: bold; color: #00f; }
</style>
</head>
<body>

<div id="login">
  <h2>Login / Register</h2>
  <input type="text" id="username" placeholder="Username">
  <input type="password" id="inviteCode" placeholder="Invite Code">
  <button id="loginBtn">Enter Chat</button>
  <p id="loginError" style="color:red;"></p>
</div>

<div id="chat" class="hidden">
  <h2>Local Chat</h2>
  <select id="groupSelect"></select>
  <div id="messages"></div>
  <input type="text" id="msgInput" placeholder="Type a message">
  <input type="file" id="fileInput">
  <button id="sendBtn">Send</button>
  <button id="ttsBtn">Speak Last Message</button>
</div>

<audio id="notifSound" src="https://www.myinstants.com/media/sounds/bleep.mp3" preload="auto"></audio>

<script>
const INVITE_CODE = "SCHOOL123"; // Example invite code
let username = "";
let currentGroup = "General";

// Local storage for messages and groups
let messages = JSON.parse(localStorage.getItem('messages')) || {};
let groups = JSON.parse(localStorage.getItem('groups')) || ["General"];

// Elements
const loginDiv = document.getElementById('login');
const chatDiv = document.getElementById('chat');
const usernameInput = document.getElementById('username');
const inviteInput = document.getElementById('inviteCode');
const loginBtn = document.getElementById('loginBtn');
const loginError = document.getElementById('loginError');
const messagesDiv = document.getElementById('messages');
const msgInput = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');
const groupSelect = document.getElementById('groupSelect');
const fileInput = document.getElementById('fileInput');
const ttsBtn = document.getElementById('ttsBtn');
const notifSound = document.getElementById('notifSound');

// Login
loginBtn.addEventListener('click', () => {
  if (!usernameInput.value) {
    loginError.textContent = "Enter a username!";
    return;
  }
  if (inviteInput.value !== INVITE_CODE) {
    loginError.textContent = "Invalid invite code!";
    return;
  }
  username = usernameInput.value;
  loginDiv.classList.add('hidden');
  chatDiv.classList.remove('hidden');
  loadGroups();
  renderMessages();
});

// Load groups
function loadGroups() {
  groupSelect.innerHTML = "";
  groups.forEach(g => {
    const option = document.createElement('option');
    option.value = g;
    option.textContent = g;
    groupSelect.appendChild(option);
  });
  groupSelect.value = currentGroup;
  groupSelect.addEventListener('change', () => {
    currentGroup = groupSelect.value;
    renderMessages();
  });
}

// Send message
sendBtn.addEventListener('click', () => {
  const text = msgInput.value.trim();
  if (!text && !fileInput.files[0]) return;

  if (!messages[currentGroup]) messages[currentGroup] = [];
  let msgObj = {user: username, text: text, file: null, time: Date.now()};
  
  if (fileInput.files[0]) {
    const reader = new FileReader();
    reader.onload = function(e) {
      msgObj.file = e.target.result;
      messages[currentGroup].push(msgObj);
      localStorage.setItem('messages', JSON.stringify(messages));
      renderMessages();
      notifSound.play();
    };
    reader.readAsDataURL(fileInput.files[0]);
  } else {
    messages[currentGroup].push(msgObj);
    localStorage.setItem('messages', JSON.stringify(messages));
    renderMessages();
    notifSound.play();
  }

  msgInput.value = "";
  fileInput.value = "";
});

// Render messages
function renderMessages() {
  messagesDiv.innerHTML = "";
  if (!messages[currentGroup]) messages[currentGroup] = [];
  messages[currentGroup].forEach(m => {
    const div = document.createElement('div');
    div.classList.add('message');
    div.innerHTML = `<span class="group">${m.user}:</span> ${m.text || ''}`;
    if (m.file) {
      const link = document.createElement('a');
      link.href = m.file;
      link.textContent = " [File]";
      link.download = "file";
      div.appendChild(link);
    }
    messagesDiv.appendChild(div);
  });
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Text-to-speech
ttsBtn.addEventListener('click', () => {
  if (!messages[currentGroup] || messages[currentGroup].length === 0) return;
  const lastMsg = messages[currentGroup][messages[currentGroup].length -1].text;
  if (!lastMsg) return;
  const utter = new SpeechSynthesisUtterance(lastMsg);
  speechSynthesis.speak(utter);
});

// Add group feature (optional)
const newGroup = prompt("Add a new group name (or cancel to skip):");
if (newGroup && !groups.includes(newGroup)) {
  groups.push(newGroup);
  localStorage.setItem('groups', JSON.stringify(groups));
}
</script>
</body>
</html>
