<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Local Multi-Tab Chat</title>
<style>
  body { margin: 0; font-family: Arial, sans-serif; background: #121212; color: #fff; }
  #login, #chat { display: none; padding: 20px; }
  #messages { height: 300px; overflow-y: auto; border: 1px solid #555; padding: 10px; margin-bottom: 10px; background: #1f1f1f; }
  input, select, button, textarea { padding: 8px; margin: 5px 0; width: 100%; border: none; border-radius: 4px; }
  button { background: #0078ff; color: #fff; cursor: pointer; }
  button:hover { background: #005fcc; }
  .message { margin-bottom: 10px; }
  .admin { background: linear-gradient(90deg, #ff0, #f0f); -webkit-background-clip: text; color: transparent; font-weight: bold; }
</style>
</head>
<body>

<div id="login">
  <h2>Login / Register</h2>
  <input id="username" placeholder="Enter username">
  <input id="invite" placeholder="Enter invite code">
  <button id="loginBtn">Login</button>
</div>

<div id="chat">
  <h2>Chat Room</h2>
  <select id="groupSelect"></select>
  <input id="newGroup" placeholder="New group name">
  <button id="createGroup">Create Group</button>
  <div id="messages"></div>
  <textarea id="msgInput" placeholder="Type a message"></textarea>
  <input type="file" id="fileInput">
  <button id="sendBtn">Send</button>
  <label><input type="checkbox" id="tts"> Text-to-Speech</label>
</div>

<script>
const INVITE_CODE = "SCHOOL123";
let currentUser = "";
let currentGroup = "";
let ttsEnabled = false;

// Show login first
document.getElementById('login').style.display = 'block';

document.getElementById('loginBtn').onclick = () => {
  const username = document.getElementById('username').value.trim();
  const invite = document.getElementById('invite').value.trim();
  if (!username || invite !== INVITE_CODE) { alert("Invalid username or invite code!"); return; }
  currentUser = username;
  document.getElementById('login').style.display = 'none';
  document.getElementById('chat').style.display = 'block';
  loadGroups();
};

function loadGroups() {
  const groups = JSON.parse(localStorage.getItem('chatGroups') || '[]');
  const select = document.getElementById('groupSelect');
  select.innerHTML = "";
  groups.forEach(g => {
    const opt = document.createElement('option');
    opt.value = g;
    opt.textContent = g;
    select.appendChild(opt);
  });
  if (groups.length > 0) {
    currentGroup = groups[0];
    loadMessages();
  }
}

document.getElementById('createGroup').onclick = () => {
  const name = document.getElementById('newGroup').value.trim();
  if (!name) return;
  let groups = JSON.parse(localStorage.getItem('chatGroups') || '[]');
  if (!groups.includes(name)) { groups.push(name); localStorage.setItem('chatGroups', JSON.stringify(groups)); }
  loadGroups();
};

document.getElementById('groupSelect').onchange = (e) => {
  currentGroup = e.target.value;
  loadMessages();
};

document.getElementById('sendBtn').onclick = sendMessage;

document.getElementById('tts').onchange = (e) => { ttsEnabled = e.target.checked; };

document.getElementById('fileInput').onchange = (e) => {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = () => { sendMessage(reader.result, file.name); };
    reader.readAsDataURL(file);
  }
};

function sendMessage(fileData, fileName) {
  const text = fileData || document.getElementById('msgInput').value.trim();
  if (!text) return;
  const messages = JSON.parse(localStorage.getItem('chatMessages') || '[]');
  messages.push({ user: currentUser, group: currentGroup, text, fileName, timestamp: Date.now() });
  localStorage.setItem('chatMessages', JSON.stringify(messages));
  document.getElementById('msgInput').value = '';
  loadMessages();
  if (ttsEnabled && !fileData) speechSynthesis.speak(new SpeechSynthesisUtterance(text));
}

function loadMessages() {
  const messages = JSON.parse(localStorage.getItem('chatMessages') || '[]')
    .filter(m => m.group === currentGroup);
  const container = document.getElementById('messages');
  container.innerHTML = '';
  messages.forEach(m => {
    const div = document.createElement('div');
    div.className = 'message';
    div.innerHTML = `<strong class="${m.user.toLowerCase() === 'admin' ? 'admin' : ''}">${m.user}:</strong> ${m.text}`;
    if (m.fileName) {
      const a = document.createElement('a');
      a.href = m.text;
      a.download = m.fileName;
      a.textContent = `[Download ${m.fileName}]`;
      div.appendChild(document.createElement('br'));
      div.appendChild(a);
    }
    container.appendChild(div);
  });
  container.scrollTop = container.scrollHeight;
}

// Sync across tabs
window.addEventListener('storage', (e) => {
  if (e.key === 'chatMessages') loadMessages();
  if (e.key === 'chatGroups') loadGroups();
});
</script>

</body>
</html>
