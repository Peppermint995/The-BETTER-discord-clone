<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Firebase Chat App with Groups & TTS</title>
<style>
:root {
  --bg: #121212;
  --card: #1f1f1f;
  --muted: rgba(255,255,255,0.7);
  --accent: #00ccff;
  --admin-gradient: linear-gradient(90deg,#ff00ff,#00ffff);
}
body { margin:0; font-family:Arial,sans-serif; background:var(--bg); color:white; }
#login, #chat { display:none; padding:20px; }
input, select, button { margin:5px; padding:8px; border-radius:5px; border:none; }
button { background:var(--accent); color:#fff; cursor:pointer; }
#chatBox { max-height:60vh; overflow-y:auto; background:var(--card); padding:10px; border-radius:8px; margin-bottom:10px; }
.message { margin-bottom:10px; }
.admin { background:var(--admin-gradient); -webkit-background-clip:text; -webkit-text-fill-color:transparent; font-weight:bold; }
#roomSelect { margin-bottom:10px; }
</style>
</head>
<body>

<div id="login">
  <h2>Login / Register</h2>
  <input id="email" type="email" placeholder="Email"><br>
  <input id="password" type="password" placeholder="Password"><br>
  <input id="invite" type="text" placeholder="Invite Code"><br>
  <button onclick="register()">Register</button>
  <button onclick="login()">Login</button>
</div>

<div id="chat">
  <h2>Chat Rooms</h2>
  <select id="roomSelect"></select>
  <div id="chatBox"></div>
  <input id="msgInput" type="text" placeholder="Type a message">
  <button onclick="sendMessage()">Send</button>
  <input type="file" id="fileInput">
</div>

<audio id="notifSound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3" preload="auto"></audio>

<script type="module">
// Firebase setup
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, query, orderByChild, onChildRemoved, get } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-database.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-storage.js";

// Firebase config
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_DOMAIN",
  databaseURL: "YOUR_DB_URL",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_BUCKET",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const storage = getStorage(app);

let currentRoom = "general";
let messagesRef;
const chatBox = document.getElementById("chatBox");
const roomSelect = document.getElementById("roomSelect");
const notifSound = document.getElementById("notifSound");
let currentNickname = "";

// Escape HTML
function escapeHtml(text) { return text.replace(/'/g,"&#39;").replace(/"/g,"&quot;"); }

// Text-to-speech
function speakMessage(text){
  if(!window.speechSynthesis) return;
  const utter = new SpeechSynthesisUtterance(text);
  window.speechSynthesis.speak(utter);
}

// Load rooms
async function loadRooms(){
  const snap = await get(ref(db,"rooms"));
  roomSelect.innerHTML = "";
  if(snap.exists()){
    const rooms = snap.val();
    Object.entries(rooms).forEach(([roomId, roomData])=>{
      const opt = document.createElement("option");
      opt.value = roomId;
      opt.textContent = roomData.name || roomId;
      roomSelect.appendChild(opt);
    });
  }
  roomSelect.value = currentRoom;
  roomSelect.onchange = () => { currentRoom = roomSelect.value; loadMessages(); };
}
loadRooms();

// Send message
async function sendMessage(){
  const text = document.getElementById("msgInput").value;
  const fileInput = document.getElementById("fileInput");
  let fileUrl = "";

  if(fileInput.files.length > 0){
    const file = fileInput.files[0];
    const storageRef = sRef(storage, `files/${Date.now()}_${file.name}`);
    await uploadBytes(storageRef, file);
    fileUrl = await getDownloadURL(storageRef);
  }

  if(!text && !fileUrl) return;
  const user = auth.currentUser;
  if(!user) return alert("Login first");

  const msgRef = ref(db, `messages/${currentRoom}`);
  await push(msgRef,{
    uid:user.uid,
    email:user.email,
    nickname: currentNickname,
    text:text,
    fileUrl:fileUrl,
    timestamp:Date.now()
  });
  document.getElementById("msgInput").value="";
  fileInput.value="";
}

// Load messages
function loadMessages(){
  if(messagesRef) onChildRemoved(messagesRef); // detach old listener
  chatBox.innerHTML="";
  messagesRef = query(ref(db, `messages/${currentRoom}`), orderByChild("timestamp"));
  onChildAdded(messagesRef, snap=>{
    const msg = snap.val();
    const div = document.createElement("div");
    div.className = "message";
    let nameClass = (msg.email==="admin@example.com")?"admin":"";
    div.innerHTML = `<strong class="${nameClass}">${escapeHtml(msg.nickname)}</strong>: 
      ${msg.text?escapeHtml(msg.text):""} 
      ${msg.text?`<span style="cursor:pointer;color:#00ccff;font-weight:bold;" onclick="speakMessage('${escapeHtml(msg.text)}')">ðŸ”Š</span>`:""}
      ${msg.fileUrl?`<a href="${msg.fileUrl}" target="_blank">[File]</a>`:""}`;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
    notifSound.play();
  });
}
loadMessages();

// Auth
function register(){
  const email = document.getElementById("email").value;
  const pass = document.getElementById("password").value;
  const invite = document.getElementById("invite").value;
  if(invite!=="1234") return alert("Invalid invite code!");
  createUserWithEmailAndPassword(auth,email,pass).then(userCred=>{
    currentNickname = email.split("@")[0];
    document.getElementById("login").style.display="none";
    document.getElementById("chat").style.display="block";
  }).catch(console.error);
}
function login(){
  const email = document.getElementById("email").value;
  const pass = document.getElementById("password").value;
  signInWithEmailAndPassword(auth,email,pass).then(userCred=>{
    currentNickname = email.split("@")[0];
    document.getElementById("login").style.display="none";
    document.getElementById("chat").style.display="block";
  }).catch(console.error);
}

// Show login initially
document.getElementById("login").style.display="block";
</script>
</body>
</html>
