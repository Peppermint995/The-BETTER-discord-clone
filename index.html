<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Firebase Chat</title>
<style>
  body { margin:0; font-family:Arial,sans-serif; background:#121212; color:white; }
  #login, #chat, #adminPanel { display:none; padding:20px; }
  input, select, button { margin:5px 0; padding:8px; width:100%; }
  .message { margin:5px 0; padding:5px; border-radius:5px; background:#1f1f1f; }
  .admin { background: linear-gradient(90deg, #ff00ff, #00ffff); -webkit-background-clip: text; color:transparent; font-weight:bold; }
  #messages { max-height:300px; overflow-y:auto; margin-bottom:10px; }
</style>
</head>
<body>

<div id="login">
  <h2>Login / Register</h2>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <input type="text" id="nickname" placeholder="Nickname">
  <input type="text" id="inviteCode" placeholder="Invite Code">
  <button id="registerBtn">Register</button>
  <button id="loginBtn">Login</button>
</div>

<div id="chat">
  <h2>Chat Rooms</h2>
  <select id="roomSelect"></select>
  <div id="messages"></div>
  <input type="text" id="messageInput" placeholder="Type a message">
  <input type="file" id="fileInput">
  <button id="sendBtn">Send</button>
  <button id="logoutBtn">Logout</button>
</div>

<div id="adminPanel">
  <h2>Admin Panel</h2>
  <div id="adminMessages"></div>
</div>

<audio id="notifSound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3"></audio>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
// -------- Firebase Config --------
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT.firebaseio.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

// -------- Elements --------
const loginDiv = document.getElementById("login");
const chatDiv = document.getElementById("chat");
const adminPanel = document.getElementById("adminPanel");
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const nicknameInput = document.getElementById("nickname");
const inviteInput = document.getElementById("inviteCode");
const registerBtn = document.getElementById("registerBtn");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const roomSelect = document.getElementById("roomSelect");
const messagesDiv = document.getElementById("messages");
const messageInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const fileInput = document.getElementById("fileInput");
const notifSound = document.getElementById("notifSound");

// -------- Invite Code --------
const INVITE_CODE = "CHAT123"; // change as needed

// -------- Auth --------
registerBtn.onclick = () => {
  if(inviteInput.value !== INVITE_CODE){ alert("Invalid invite code"); return; }
  auth.createUserWithEmailAndPassword(emailInput.value, passwordInput.value)
  .then(cred => {
    db.ref("users/"+cred.user.uid).set({nickname: nicknameInput.value, email: emailInput.value, admin:false});
  }).catch(alert);
}

loginBtn.onclick = () => {
  auth.signInWithEmailAndPassword(emailInput.value, passwordInput.value)
  .catch(alert);
}

logoutBtn.onclick = () => { auth.signOut(); };

// -------- Load Rooms --------
function loadRooms(){
  db.ref("rooms").once("value").then(snapshot => {
    roomSelect.innerHTML = "";
    snapshot.forEach(r => {
      const opt = document.createElement("option");
      opt.value = r.key;
      opt.textContent = r.val().name;
      roomSelect.appendChild(opt);
    });
  });
}

// -------- Load Messages --------
function loadMessages(room){
  messagesDiv.innerHTML = "";
  const msgsRef = db.ref("messages/"+room);
  msgsRef.off(); // remove old listeners
  msgsRef.on("child_added", snap => {
    const msg = snap.val();
    const div = document.createElement("div");
    div.className = "message";
    if(msg.admin) div.innerHTML = `<span class="admin">${msg.nickname}:</span> ${msg.text || ""}`;
    else div.textContent = msg.nickname + ": " + (msg.text || "");
    if(msg.file) div.innerHTML += `<br><a href="${msg.file}" target="_blank">[File]</a>`;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    notifSound.play();
    // text-to-speech
    if(msg.text) new SpeechSynthesisUtterance(msg.text).voice = speechSynthesis.getVoices()[0], speechSynthesis.speak(new SpeechSynthesisUtterance(msg.text));
  });
}

// -------- Send Message --------
sendBtn.onclick = () => {
  const room = roomSelect.value;
  const text = messageInput.value;
  const file = fileInput.files[0];
  if(!room) return alert("Select room");
  if(file){
    const ref = storage.ref("files/"+Date.now()+"_"+file.name);
    ref.put(file).then(() => ref.getDownloadURL().then(url => {
      db.ref("messages/"+room).push({nickname:nicknameInput.value,text:text||"",file:url,timestamp:Date.now()});
    }));
  } else {
    db.ref("messages/"+room).push({nickname:nicknameInput.value,text:text||"",timestamp:Date.now()});
  }
  messageInput.value="";
  fileInput.value="";
}

// -------- Room Change --------
roomSelect.onchange = () => { loadMessages(roomSelect.value); }

// -------- Auth State --------
auth.onAuthStateChanged(user => {
  if(user){
    loginDiv.style.display="none";
    chatDiv.style.display="block";
    loadRooms();
    // load first room messages
    setTimeout(()=>{ if(roomSelect.value) loadMessages(roomSelect.value); },500);
  } else {
    loginDiv.style.display="block";
    chatDiv.style.display="none";
  }
});

// -------- Preload Demo Rooms & Messages --------
db.ref("rooms").once("value").then(snap => {
  if(!snap.exists()){
    db.ref("rooms").set({general:{name:"General"},games:{name:"Games"}});
    db.ref("messages/general").push({nickname:"Admin",text:"Welcome to the chat!",admin:true,timestamp:Date.now()});
  }
});
</script>
</body>
</html>
