<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced Firebase Chat</title>
<style>
  body {
    margin:0;
    font-family: Arial, sans-serif;
    background: #121212;
    color: #fff;
    display:flex;
    height:100vh;
  }
  #sidebar {
    width:250px;
    background:#1f1f1f;
    padding:10px;
    display:flex;
    flex-direction:column;
    overflow-y:auto;
  }
  #chat-container {
    flex:1;
    display:flex;
    flex-direction:column;
    background:#121212;
  }
  #messages {
    flex:1;
    padding:10px;
    overflow-y:auto;
    word-wrap: break-word;
  }
  #input-container {
    display:flex;
  }
  #message-input {
    flex:1;
    padding:10px;
    border:none;
    outline:none;
    font-size:16px;
  }
  button {
    padding:10px;
    font-size:16px;
    cursor:pointer;
    background:#0078ff;
    color:white;
    border:none;
  }
  .admin {
    font-weight:bold;
    background: linear-gradient(90deg, red, yellow, green, cyan, blue, magenta);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: gradientAnim 5s linear infinite;
  }
  @keyframes gradientAnim {
    0% { background-position:0% 50%; }
    50% { background-position:100% 50%; }
    100% { background-position:0% 50%; }
  }
  .message {
    margin-bottom:5px;
  }
  .bold { font-weight:bold; }
  .italic { font-style:italic; }
</style>
</head>
<body>
<div id="sidebar">
  <h3>Groups</h3>
  <div id="groups"></div>
  <button id="create-group-btn">Create Group</button>
  <hr>
  <h3>Broadcasts (Admins Only)</h3>
  <div id="broadcasts"></div>
  <button id="send-broadcast-btn">Send Broadcast</button>
</div>
<div id="chat-container">
  <div id="messages"></div>
  <div id="input-container">
    <input type="text" id="message-input" placeholder="Type a message">
    <button id="send-btn">Send</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  databaseURL: "YOUR_DATABASE_URL",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();

let currentUser = null;
let currentGroup = null;

// Persistent login
auth.onAuthStateChanged(user => {
  if(user){
    currentUser = user;
    if(!user.displayName){
      const name = prompt("Choose a display name:");
      user.updateProfile({displayName:name});
    }
    initChat();
  } else {
    const email = prompt("Enter your email:");
    const password = prompt("Enter a password:");
    auth.signInWithEmailAndPassword(email,password)
      .catch(() => auth.createUserWithEmailAndPassword(email,password));
  }
});

function initChat(){
  loadGroups();
  loadMessages();
  loadBroadcasts();
}

// Groups
function loadGroups(){
  db.ref("groups").on("value", snapshot => {
    const groupsDiv = document.getElementById("groups");
    groupsDiv.innerHTML = "";
    snapshot.forEach(g => {
      const btn = document.createElement("button");
      btn.textContent = g.key;
      btn.onclick = () => { currentGroup = g.key; loadMessages(); };
      groupsDiv.appendChild(btn);
    });
  });
}

document.getElementById("create-group-btn").onclick = () => {
  if(!currentUser.isAdmin) return;
  const group = prompt("Enter group name:");
  if(group) db.ref("groups/"+group).set({createdBy:currentUser.email});
};

// Messages
function loadMessages(){
  if(!currentGroup) return;
  db.ref("messages/"+currentGroup).on("child_added", snapshot => {
    const msg = snapshot.val();
    displayMessage(msg);
  });
}

function displayMessage(msg){
  const div = document.createElement("div");
  div.className = "message";
  let content = msg.text;
  if(msg.bold) content = `<span class="bold">${content}</span>`;
  if(msg.italic) content = `<span class="italic">${content}</span>`;
  if(msg.color) content = `<span style="color:${msg.color}">${content}</span>`;
  if(msg.admin) content = `<span class="admin">${msg.sender}</span>: ${content}`;
  else content = `<strong>${msg.sender}</strong>: ${content}`;
  div.innerHTML = content;
  document.getElementById("messages").appendChild(div);
  div.scrollIntoView();
  if(msg.tts) speak(msg.text);
}

function speak(text){
  const utter = new SpeechSynthesisUtterance(text);
  speechSynthesis.speak(utter);
}

document.getElementById("send-btn").onclick = sendMessage;
document.getElementById("message-input").addEventListener("keypress", e => {
  if(e.key==="Enter") sendMessage();
});

function sendMessage(){
  const input = document.getElementById("message-input");
  if(!input.value) return;
  const text = input.value;
  const msgObj = {
    sender: currentUser.displayName || currentUser.email,
    text: text,
    admin: currentUser.email.endsWith("@ahschools.us"), // simple admin check
    bold:false, italic:false, color:null, tts:false
  };
  db.ref("messages/"+(currentGroup||"general")).push(msgObj);
  input.value="";
}

// Broadcasts
function loadBroadcasts(){
  db.ref("broadcasts").on("child_added", snapshot => {
    const msg = snapshot.val();
    const div = document.createElement("div");
    div.innerHTML = `<strong>${msg.sender}</strong>: ${msg.text}`;
    document.getElementById("broadcasts").appendChild(div);
    speak(msg.text);
  });
}

document.getElementById("send-broadcast-btn").onclick = () => {
  if(!currentUser.email.endsWith("@ahschools.us")) return alert("Admins only");
  const text = prompt("Enter broadcast message:");
  db.ref("broadcasts").push({sender:currentUser.displayName,text});
};
</script>
</body>
</html>

